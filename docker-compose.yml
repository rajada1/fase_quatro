version: "3.8"

# =========================================================
#  Docker Compose COMPLETO - Oficina MecÃ¢nica
#  Roda TODOS os microserviÃ§os + infraestrutura
#  (Kafka, PostgreSQL, DynamoDB, Gateway)
#
#  Uso: docker compose up -d --build
#  Parar: docker compose down
#  Parar + remover volumes: docker compose down -v
# =========================================================

services:

  # ======================== INFRAESTRUTURA ========================

  # PostgreSQL Principal (porta 5432 dentro do container)
  # Bancos: osservice_db, customer_db, notification_db,
  #         operations_db, people_db, hr_db, maintenance_db
  postgres-main:
    image: postgres:16-alpine
    container_name: oficina-postgres-main
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_main_data:/var/lib/postgresql/data
      - ./init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - oficina-network

  # PostgreSQL - Execution Service (porta 5433)
  postgres-execution:
    image: postgres:16-alpine
    container_name: oficina-postgres-execution
    environment:
      POSTGRES_DB: execution_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    ports:
      - "5433:5432"
    volumes:
      - postgres_exec_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - oficina-network

  # DynamoDB Local - Billing + Catalog Service (porta 8000)
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: oficina-dynamodb
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -inMemory"
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - oficina-network

  # DynamoDB Init - Cria tabelas locais
  dynamodb-init:
    image: curlimages/curl:latest
    container_name: oficina-dynamodb-init
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        AUTH='Authorization: AWS4-HMAC-SHA256 Credential=fakeAccessKey/20260101/us-east-1/dynamodb/aws4_request, SignedHeaders=content-type;host;x-amz-target, Signature=fake' &&
        echo 'Waiting for DynamoDB Local...' &&
        sleep 3 &&
        echo 'Creating table orcamentos...' &&
        curl -s -X POST http://dynamodb-local:8000 \
          -H 'Content-Type: application/x-amz-json-1.0' \
          -H 'X-Amz-Target: DynamoDB_20120810.CreateTable' \
          -H "$$AUTH" \
          -d '{"TableName":"orcamentos","KeySchema":[{"AttributeName":"id","KeyType":"HASH"}],"AttributeDefinitions":[{"AttributeName":"id","AttributeType":"S"}],"BillingMode":"PAY_PER_REQUEST"}' &&
        echo '' &&
        echo 'Creating table pagamentos...' &&
        curl -s -X POST http://dynamodb-local:8000 \
          -H 'Content-Type: application/x-amz-json-1.0' \
          -H 'X-Amz-Target: DynamoDB_20120810.CreateTable' \
          -H "$$AUTH" \
          -d '{"TableName":"pagamentos","KeySchema":[{"AttributeName":"id","KeyType":"HASH"}],"AttributeDefinitions":[{"AttributeName":"id","AttributeType":"S"}],"BillingMode":"PAY_PER_REQUEST"}' &&
        echo '' &&
        echo 'Creating table pecas...' &&
        curl -s -X POST http://dynamodb-local:8000 \
          -H 'Content-Type: application/x-amz-json-1.0' \
          -H 'X-Amz-Target: DynamoDB_20120810.CreateTable' \
          -H "$$AUTH" \
          -d '{"TableName":"pecas","KeySchema":[{"AttributeName":"id","KeyType":"HASH"}],"AttributeDefinitions":[{"AttributeName":"id","AttributeType":"S"}],"BillingMode":"PAY_PER_REQUEST"}' &&
        echo '' &&
        echo 'Creating table servicos...' &&
        curl -s -X POST http://dynamodb-local:8000 \
          -H 'Content-Type: application/x-amz-json-1.0' \
          -H 'X-Amz-Target: DynamoDB_20120810.CreateTable' \
          -H "$$AUTH" \
          -d '{"TableName":"servicos","KeySchema":[{"AttributeName":"id","KeyType":"HASH"}],"AttributeDefinitions":[{"AttributeName":"id","AttributeType":"S"}],"BillingMode":"PAY_PER_REQUEST"}' &&
        echo '' &&
        echo 'Listing tables...' &&
        curl -s -X POST http://dynamodb-local:8000 \
          -H 'Content-Type: application/x-amz-json-1.0' \
          -H 'X-Amz-Target: DynamoDB_20120810.ListTables' \
          -H "$$AUTH" \
          -d '{}' &&
        echo '' &&
        echo 'DynamoDB tables ready!'
    depends_on:
      dynamodb-local:
        condition: service_healthy
    networks:
      - oficina-network

  # Zookeeper (Kafka dependency)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: oficina-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - oficina-network

  # Kafka (cluster Ãºnico compartilhado)
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: oficina-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      KAFKA_LOG_RETENTION_HOURS: 720
      KAFKA_NUM_PARTITIONS: 6
    ports:
      - "9092:9092"
      - "29092:29092"
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 15s
      timeout: 10s
      retries: 10
    networks:
      - oficina-network

  # Kafka Topics Initialization
  kafka-init:
    image: confluentinc/cp-kafka:7.5.0
    container_name: oficina-kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    command: |
      bash -c "
        echo 'ðŸ”§ Creating Kafka topics for Saga Pattern...'
        sleep 5

        kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 6 --replication-factor 1 --config retention.ms=2592000000 --topic os-events
        kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --config retention.ms=2592000000 --topic billing-events
        kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --config retention.ms=2592000000 --topic execution-events
        kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic compensacao-events
        kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic dlt-os-events
        kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic dlt-billing-events
        kafka-topics --create --if-not-exists --bootstrap-server kafka:29092 --partitions 3 --replication-factor 1 --topic dlt-execution-events

        echo 'âœ… Topics created:'
        kafka-topics --list --bootstrap-server kafka:29092
      "
    networks:
      - oficina-network

  # Kafka UI (debug/monitoramento) - http://localhost:9090
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: oficina-kafka-ui
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      KAFKA_CLUSTERS_0_NAME: oficina-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    ports:
      - "9090:8080"
    networks:
      - oficina-network

  # ======================== MICROSERVIÃ‡OS ========================

  # OS Service (porta 8081)
  os-service:
    build:
      context: ./oficina-os-service
      dockerfile: Dockerfile
    container_name: oficina-os-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-main:5432/osservice_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_FLYWAY_ENABLED: "true"
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: "true"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SPRING_KAFKA_CONSUMER_GROUP_ID: os-service-group
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SECURITY_DISABLED: "true"
      LOG_LEVEL: INFO
      SERVER_PORT: 8081
    ports:
      - "8081:8081"
    depends_on:
      postgres-main:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Billing Service (porta 8082)
  billing-service:
    build:
      context: ./oficina-billing-service
      dockerfile: Dockerfile
    container_name: oficina-billing-service
    environment:
      AWS_DYNAMODB_ENDPOINT: http://dynamodb-local:8000
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: fakeAccessKey
      AWS_SECRET_ACCESS_KEY: fakeSecretKey
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SECURITY_DISABLED: "true"
      LOG_LEVEL: INFO
      SERVER_PORT: 8082
      MERCADOPAGO_ACCESS_TOKEN: APP_USR-2277051623873712-021601-718706927f815175b6eb2f9dcb9ff053-1540002520
    ports:
      - "8082:8082"
    depends_on:
      dynamodb-init:
        condition: service_completed_successfully
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Execution Service (porta 8083)
  execution-service:
    build:
      context: ./oficina-execution-service
      dockerfile: Dockerfile
    container_name: oficina-execution-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-execution:5432/execution_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_FLYWAY_ENABLED: "true"
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: "true"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SECURITY_DISABLED: "true"
      LOG_LEVEL: INFO
      SERVER_PORT: 8083
    ports:
      - "8083:8083"
    depends_on:
      postgres-execution:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Customer Service (porta 8084)
  customer-service:
    build:
      context: ./oficina-customer-service
      dockerfile: Dockerfile
    container_name: oficina-customer-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-main:5432/customer_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SECURITY_DISABLED: "true"
      LOG_LEVEL: INFO
      SERVER_PORT: 8084
    ports:
      - "8084:8084"
    depends_on:
      postgres-main:
        condition: service_healthy
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Catalog Service (porta 8085)
  catalog-service:
    build:
      context: ./oficina-catalog-service
      dockerfile: Dockerfile
    container_name: oficina-catalog-service
    environment:
      AWS_DYNAMODB_ENDPOINT: http://dynamodb-local:8000
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: fakeAccessKey
      AWS_SECRET_ACCESS_KEY: fakeSecretKey
      SECURITY_DISABLED: "true"
      LOG_LEVEL: INFO
      SERVER_PORT: 8085
    ports:
      - "8085:8085"
    depends_on:
      dynamodb-init:
        condition: service_completed_successfully
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # People Service (porta 8086)
  people-service:
    build:
      context: ./oficina-people-service
      dockerfile: Dockerfile
    container_name: oficina-people-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-main:5432/people_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SECURITY_DISABLED: "true"
      LOG_LEVEL: INFO
      SERVER_PORT: 8086
    ports:
      - "8086:8086"
    depends_on:
      postgres-main:
        condition: service_healthy
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # HR Service (porta 8087)
  hr-service:
    build:
      context: ./oficina-hr-service
      dockerfile: Dockerfile
    container_name: oficina-hr-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-main:5432/hr_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SECURITY_DISABLED: "true"
      LOG_LEVEL: INFO
      SERVER_PORT: 8087
    ports:
      - "8087:8087"
    depends_on:
      postgres-main:
        condition: service_healthy
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Maintenance Service (porta 8088)
  maintenance-service:
    build:
      context: ./oficina-maintenance-service
      dockerfile: Dockerfile
    container_name: oficina-maintenance-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-main:5432/maintenance_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SECURITY_DISABLED: "true"
      LOG_LEVEL: INFO
      SERVER_PORT: 8088
    ports:
      - "8088:8088"
    depends_on:
      postgres-main:
        condition: service_healthy
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Notification Service (porta 8089)
  notification-service:
    build:
      context: ./oficina-notification-service
      dockerfile: Dockerfile
    container_name: oficina-notification-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-main:5432/notification_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SECURITY_DISABLED: "true"
      LOG_LEVEL: INFO
      SERVER_PORT: 8089
    ports:
      - "8089:8089"
    depends_on:
      postgres-main:
        condition: service_healthy
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8089/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Operations Service (porta 8090)
  operations-service:
    build:
      context: ./oficina-operations-service
      dockerfile: Dockerfile
    container_name: oficina-operations-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-main:5432/operations_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SECURITY_DISABLED: "true"
      LOG_LEVEL: INFO
      SERVER_PORT: 8090
    ports:
      - "8090:8090"
    depends_on:
      postgres-main:
        condition: service_healthy
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # ======================== GATEWAY ========================

  # API Gateway (porta 8080) - Ponto de entrada Ãºnico
  gateway:
    build:
      context: ./oficina-gateway
      dockerfile: Dockerfile
    container_name: oficina-gateway
    environment:
      SPRING_PROFILES_ACTIVE: default
      JWT_SECRET: YWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXoxMjM0NTY3ODkwYWJjZGVmZw==
      OS_SERVICE_URL: http://os-service:8081
      BILLING_SERVICE_URL: http://billing-service:8082
      EXECUTION_SERVICE_URL: http://execution-service:8083
      CUSTOMER_SERVICE_URL: http://customer-service:8084
      CATALOG_SERVICE_URL: http://catalog-service:8085
      PEOPLE_SERVICE_URL: http://people-service:8086
      HR_SERVICE_URL: http://hr-service:8087
      MAINTENANCE_SERVICE_URL: http://maintenance-service:8088
      NOTIFICATION_SERVICE_URL: http://notification-service:8089
      OPERATIONS_SERVICE_URL: http://operations-service:8090
    ports:
      - "8080:8080"
    depends_on:
      os-service:
        condition: service_started
      billing-service:
        condition: service_started
      execution-service:
        condition: service_started
    networks:
      - oficina-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  postgres_main_data:
  postgres_exec_data:

networks:
  oficina-network:
    driver: bridge
